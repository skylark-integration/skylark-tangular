/**
 * skylark-tangular - A version of tangular.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-tangular/
 * @license MIT
 */
define(["./tangular"],function(e){var i={null:!0,undefined:!0,true:!0,false:!0},r=/&&|\|\|/,t=/[a-z0-9._]+/gi,s=/^[a-z0-9_$]+/i,l=/^[0-9]/,n=/'.*?'|".?"/g,a=/\{\{.*?\}\}/g,u=/\{\{|\}\}/g,o=/\n$/g;function p(){this.commands,this.variables,this.builder,this.split="\0"}p.prototype.compile=function(e){var r,t=this,l=0,n=0,p=[];t.variables={},t.commands=[],t.builder=e.replace(a,function(e){var a,o=e.replace(u,"").trim(),f=null,c=null,h=!1,m=!1,d=!0;if("fi"===o)l--;else if("end"===o)n--,p.pop();else if("if "===o.substring(0,3)){if(l++,(f=t.parseVariables(o.substring(3),p)).length)for(var b=0;b<f.length;b++){var g=f[b];t.variables[g]?t.variables[g]++:t.variables[g]=1}else f=null;h=!0,d=!0}else if("foreach "===o.substring(0,8))n++,r=o.substring(8).split(" "),p.push(r[0].trim()),-1!==(a=r[2].indexOf("."))&&(r[2]=r[2].substring(0,a)),f=r[2].trim(),-1===p.indexOf(f)?(t.variables[f]?t.variables[f]++:t.variables[f]=1,f=[f]):f=null,m=!0;else if("else if "===o.substring(0,8)){if((f=t.parseVariables(o.substring(8),p)).length)for(b=0;b<f.length;b++){g=f[b];t.variables[g]?t.variables[g]++:t.variables[g]=1}else f=null;h=!0}else if("continue"!==o&&"break"!==o&&"else"!==o){if((f=o?o.match(s):null)&&(f=f.toString()),f&&i[f]&&(f=null),f&&-1===p.indexOf(f)?(t.variables[f]?t.variables[f]++:t.variables[f]=1,f=[f]):f=null,-1===o.indexOf("|")&&(o+=" | encode"),o=(c=o.split("|"))[0],(c=c.slice(1)).length)for(b=0;b<c.length;b++){var v=c[b].trim();v=-1===(a=v.indexOf("("))?"Thelpers.$execute(model,'"+v+"',)":"Thelpers.$execute(model,'"+v.substring(0,a)+"',,"+v.substring(a+1),c[b]=v}else c=null;o=t.safe(o.trim()||"model"),d=!1}return t.commands.push({index:t.commands.length,cmd:o,ifcount:l,loopcount:n,variable:f,helpers:c,isloop:m,isif:h,iscode:d}),t.split}).split(t.split);for(var f=0,c=t.builder.length;f<c;f++)t.builder[f]=t.builder[f].replace(o,"");return t.make()},p.prototype.parseVariables=function(e,s){for(var a=[],u=e.split(r),o=0,p=u.length;o<p;o++)for(var f=u[o].replace(n,""),c=f.match(t),h=0;h<c.length;h++)!(f=(f=c[h]).split(".")[0])||l.test(f)||i[f]||-1===a.indexOf(f)&&-1===s.indexOf(f)&&a.push(f);return a},p.prototype.safe=function(e){for(var i=e.split("."),r=[],t=1;t<i.length;t++){var s=i.slice(0,t).join(".");r.push(s+"==null?'':")}return r.join("")+i.join(".")},p.prototype.make=function(){for(var e=["var $output=$text[0];var $tmp;var $index=0;"],i=0,r=this.commands.length;i<r;i++){var t,s=this.commands[i];if(i&&e.push("$output+=$text["+i+"];"),s.iscode)if(s.isloop){var l="$i"+Math.random().toString(16).substring(3,6),n=l+"a";t=s.cmd.substring(s.cmd.lastIndexOf(" in ")+4).trim(),t=n+"="+this.safe(t)+";if(!("+n+" instanceof Array)){if("+n+"&&typeof("+n+")==='object')"+n+"=Tangular.toArray("+n+")}if("+n+" instanceof Array&&"+n+".length){for(var "+l+"=0,"+l+"l="+n+".length;"+l+"<"+l+"l;"+l+"++){$index="+l+";var "+s.cmd.split(" ")[1]+"="+n+"["+l+"];",e.push(t)}else if(s.isif)"else if "===s.cmd.substring(0,8)?e.push("}"+s.cmd.substring(0,8).trim()+"("+s.cmd.substring(8).trim()+"){"):e.push(s.cmd.substring(0,3).trim()+"("+s.cmd.substring(3).trim()+"){");else switch(s.cmd){case"else":e.push("}else{");break;case"end":e.push("}}");break;case"fi":e.push("}");break;case"break":e.push("break;");break;case"continue":e.push("continue;")}else if(s.helpers){for(var a="",u=0;u<s.helpers.length;u++){var o=s.helpers[u];a=0===u?o.replace("",s.cmd.trim()).trim():o.replace("",a.trim())}e.push("$tmp="+a+";if($tmp!=null)$output+=$tmp;")}else e.push("if("+s.cmd+"!=null)$output+="+s.cmd+";")}e.push((r?"$output+=$text["+r+"];":"")+"returnÂ $output;"),delete this.variables.$;var p=Object.keys(this.variables),f=["$ || {}","model"];for(i=0;i<p.length;i++)f.push("model."+p[i]);var c="var tangular=function($,model"+(p.length?","+p.join(","):"")+"){"+e.join("")+"};return function(model,$){return tangular("+f.join(",")+");}";return new Function("$text",c)(this.builder)}});
//# sourceMappingURL=sourcemaps/Template.js.map
